<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Title</title>
</head>

<body>
  <p>Conformance Framework Mock App</p>
  <p>This app is only used by the conformance framework for test purposes</p>
  <p></p>
  <p id="context"></p>
  <script src="lib/mock-functions.js"></script>
  <script>
    onFdc3Ready().then(() => {
      let firedOnce = false;
      const stats = document.getElementById("context");

      const fdc3ApiCalls = async (context) => {
        let testChannel;
        switch (context.reverseFunctionCallOrder) {
          case false:
            testChannel = await joinChannel(context.joinAppChannel);
            await broadcast(context, testChannel);
            break;
          case true:
            await broadcast(context);
            testChannel = await joinChannel(context.joinAppChannel);
            break;
        }
        addCloseWindowListener(testChannel);

        if (context.executionComplete) {
          executionCompleteBroadcast(testChannel);
        }
      }

      const addCloseWindowListener = async (testChannel) => {
        if (testChannel === undefined) {
          await window.fdc3.addContextListener(
            "closeWindow",
            () => closeFinsembleWindow());
        } else {
          await testChannel.addContextListener(
            "closeWindow",
            () => closeFinsembleWindow());
        }
      }

      const joinChannel = async (useAppChannel) => {
        if (useAppChannel) {
          return await joinAppChannel();
        } else {
          await joinSystemChannel();
        }
      }

      const broadcast = async (context, testChannel) => {
        if (testChannel === undefined) {
          await systemBroadcast(context.contextBroadcasts);
        } else {
          await appChannelBroadcast(context, testChannel);
        }
      }

      //Channels app joins channel 1
      const joinSystemChannel = async () => {
        const channels = await window.fdc3.getSystemChannels();
        if (channels.length > 0) {
          try {
            await window.fdc3.joinChannel(channels[0].id);
            stats.innerHTML += `Joined user channel ${channels[0].id}/ `;
          } catch (ex) {
            stats.innerHTML += `Error while attempting to join user channel: ${ex.message ?? ex}/ `
          }
        } else {
          stats.innerHTML += "Error: No system channels available for app B/ ";
        }
      }

      //Channels app joins test-channel
      const joinAppChannel = async () => {
        try {
          const appChannel = await fdc3.getOrCreateChannel("test-channel");
          stats.innerHTML += "Joined app channel/ ";
          return appChannel;
        } catch (ex) {
          stats.innerHTML += `Error while attempting to join app channel: ${ex.message ?? ex}/ `
        }
      }

      const systemBroadcast = async (contextBroadcasts) => {
        for (const context in contextBroadcasts) {
          if (contextBroadcasts[context]) {
            await window.fdc3.broadcast({
              "type": `fdc3.${context}`
            });
            stats.innerHTML += `System broadcast: fdc3.${context}/ `;
          }
        };
      }

      const appChannelBroadcast = async (context, testChannel) => {
        let items = 1;
        if (context.broadcastMultipleItems) {
          items = 2;
        }
        try {
          for (const systemContext in context.contextBroadcasts) {
            if (context.contextBroadcasts[systemContext]) {
              for (let i = 0; i < items; i++) {
                await testChannel.broadcast({
                  "type": `fdc3.${systemContext}`,
                  "name": `History-item-${i + 1}`
                });
                stats.innerHTML += `App channel broadcast: fdc3.${systemContext} -- History-item-${i + 1}/ `;
              }
            }
          };
        } catch (ex) {
          stats.innerHTML += `Error while attempting to broadcast to app channel. ${ex.message ?? ex}`;
        }
      }

      //Let app A know that execution in app B is complete
      const executionCompleteBroadcast = async (testChannel) => {
        try {
          if (testChannel === undefined) {
            await window.fdc3.broadcast({
              "type": "executionComplete"
            });
          } else {
            await testChannel.broadcast({
              "type": "executionComplete"
            });
          }
        } catch (ex) {
          stats.innerHTML += `Error while attempting to broadcast executionComplete type. ${ex.message ?? ex}`;
        }
      }

      //Retrieve context
      window.fdc3.addContextListener(
        "channelsAppContext",
        (context) => {
          if (firedOnce === false) {
            firedOnce = true;
            fdc3ApiCalls(context);
          }
        });
    });
  </script>
</body>

</html>